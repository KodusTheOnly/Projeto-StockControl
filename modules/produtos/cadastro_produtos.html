<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gest√£o de Produtos (RF03.1)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #0077cc;
      margin-bottom: 20px;
    }
    .info-box {
      background: #f1f7fe;
      border-left: 4px solid #0077cc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .info-box p {
      margin: 5px 0;
      color: #333;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    label {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background-color: #0077cc;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      grid-column: span 2;
    }
    button:hover {
      background-color: #005fa3;
    }
    .search-box {
      margin-bottom: 20px;
    }
    .search-box input {
      width: 300px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .actions {
      display: flex;
      gap: 5px;
    }
    .actions button {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }
    .view {
      background-color: #0077cc;
      color: white;
    }
    .view:hover {
      background-color: #005fa3;
    }
    /* Estilos para indicadores de alerta */
    .alert-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    .alert-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .alert-active {
      background-color: #dc3545;
      color: white;
      animation: pulse 2s infinite;
    }
    .alert-configured {
      background-color: #28a745;
      color: white;
    }
    .alert-none {
      background-color: #6c757d;
      color: white;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    .menu-links {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .menu-links a {
      color: #0077cc;
      text-decoration: none;
      font-weight: 600;
      padding: 10px 20px;
      background: #f1f7fe;
      border-radius: 4px;
      transition: all 0.3s;
    }
    .menu-links a:hover {
      background: #0077cc;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- RF03 - Interface de cadastro de produtos e lotes -->
    <h2>Gest√£o de Produtos e Lotes</h2>
    
    <!-- Menu de navega√ß√£o -->
    <div class="menu-links">
      <a href="../alertas/gerenciar_alertas.html">üîî Gerenciar Alertas de Validade</a>
      <a href="../filiais/login_filiais.php">üè¢ Gest√£o de Filiais</a>
      <a href="../autenticacao/logout.php">üö™ Sair</a>
    </div>

    <div class="info-box">
      <p><strong>Como funciona:</strong></p>
      <p>‚Ä¢ Se o produto j√° existe, ser√° adicionado apenas um novo lote</p>
      <p>‚Ä¢ Se o produto n√£o existe, ser√° criado o produto e o primeiro lote</p>
      <p>‚Ä¢ üî¥ = Alerta ativo (produto pr√≥ximo do vencimento)</p>
      <p>‚Ä¢ üü¢ = Alerta configurado | ‚ö™ = Sem alerta</p>
    </div>

    <form id="form-produto">
      <div>
        <label for="nome">Nome do Produto</label>
        <input type="text" id="nome" name="nome" required>
      </div>
      <div>
        <label for="categoria">Categoria</label>
        <select id="categoria" name="categoria" required>
          <option value="">Selecione...</option>
          <option>Bebidas</option>
          <option>Higiene</option>
          <option>Alimentos</option>
          <option>Limpeza</option>
        </select>
      </div>
      <div>
        <label for="fornecedor">Fornecedor</label>
        <input type="text" id="fornecedor" name="fornecedor" required>
      </div>
      <div>
        <label for="lote">Lote</label>
        <input type="text" id="lote" name="lote" required>
      </div>
      <div>
        <label for="validade">Validade</label>
        <input type="date" id="validade" name="validade" required>
      </div>
      <div>
        <label for="quantidade">Quantidade</label>
        <input type="number" id="quantidade" name="quantidade" min="0" required>
      </div>
      <button type="submit">Adicionar Produto/Lote</button>
    </form>

    <div class="search-box">
      <input type="text" id="buscar" placeholder="Buscar produto...">
    </div>

    <table id="tabela-produtos">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Categoria</th>
          <th>Fornecedor</th>
          <th>Quantidade</th>
          <th>Pr√≥x. Validade</th>
          <th>Alertas</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <!-- Produtos aparecem aqui -->
      </tbody>
    </table>
  </div>

  <script>
    const form = document.getElementById('form-produto');
    const tabela = document.getElementById('tabela-produtos').querySelector('tbody');
    const buscarInput = document.getElementById('buscar');
    const API_URL = 'produtos.php';
    const API_ALERTAS = '../alertas/alertas.php';

    let produtos = [];
    let alertasPorProduto = {};

    // Cria c√©lula da tabela
    function criarCelula(tr, valor) {
      const td = document.createElement('td');
      td.textContent = valor ?? '-';
      tr.appendChild(td);
    }

    // Busca alertas configurados
    async function carregarAlertas() {
      try {
        const resposta = await fetch(API_ALERTAS);
        const resultado = await resposta.json();
        
        if (resultado.success) {
          alertasPorProduto = {};
          resultado.alertas.forEach(alerta => {
            if (!alertasPorProduto[alerta.produto_id]) {
              alertasPorProduto[alerta.produto_id] = [];
            }
            alertasPorProduto[alerta.produto_id].push(alerta);
          });
        }
      } catch (erro) {
        console.error('Erro ao carregar alertas:', erro);
      }
    }

    // Cria indicador de alerta
    function criarIndicadorAlerta(produtoId) {
      const alertas = alertasPorProduto[produtoId] || [];
      const div = document.createElement('div');
      div.className = 'alert-indicator';
      
      if (alertas.length === 0) {
        div.innerHTML = `
          <span class="alert-icon alert-none">‚ö™</span>
          <span>Sem alerta</span>
        `;
      } else {
        const alertasAtivos = alertas.filter(a => a.status === 'ativo');
        
        if (alertasAtivos.length > 0) {
          div.innerHTML = `
            <span class="alert-icon alert-active">üî¥</span>
            <span>${alertasAtivos.length} ativo(s)</span>
          `;
        } else {
          div.innerHTML = `
            <span class="alert-icon alert-configured">üü¢</span>
            <span>${alertas.length} configurado(s)</span>
          `;
        }
      }
      
      return div;
    }

    // Renderiza tabela com filtro opcional
    function renderTabela(filtro = '') {
      const termo = (filtro || '').toLowerCase();
      tabela.innerHTML = '';

      produtos
        .filter(p => (p.nome || '').toLowerCase().includes(termo))
        .forEach(p => {
          const tr = document.createElement('tr');
          
          criarCelula(tr, p.nome);
          criarCelula(tr, p.categoria);
          criarCelula(tr, p.fornecedor_padrao);
          criarCelula(tr, p.quantidade_total || 0);
          criarCelula(tr, (p.proxima_validade || '').substring(0, 10));
          
          // Adiciona indicador de alerta
          const tdAlerta = document.createElement('td');
          tdAlerta.appendChild(criarIndicadorAlerta(p.id));
          tr.appendChild(tdAlerta);

          const tdAcoes = document.createElement('td');
          tdAcoes.classList.add('actions');
          tdAcoes.innerHTML = `
            <button class="view" onclick="visualizarProduto(${p.id})">Visualizar</button>
          `;
          tr.appendChild(tdAcoes);

          tabela.appendChild(tr);
        });
    }

    // RF03.2 - Busca produtos na API
    async function carregarProdutos() {
      try {
        const resposta = await fetch(API_URL);
        if (!resposta.ok) {
          throw new Error('N√£o foi poss√≠vel carregar os produtos.');
        }
        const resultado = await resposta.json();
        if (!resultado.success) {
          throw new Error(resultado.error || 'Erro ao buscar produtos.');
        }

        produtos = resultado.produtos || [];
        
        // Carrega alertas antes de renderizar
        await carregarAlertas();
        
        renderTabela(buscarInput.value);
      } catch (erro) {
        alert(erro.message);
      }
    }

    // RF03.1 - Submete novo produto/lote
    form.addEventListener('submit', async evento => {
      evento.preventDefault();

      const payload = {
        nome: form.nome.value,
        categoria: form.categoria.value,
        fornecedor: form.fornecedor.value,
        lote: form.lote.value,
        validade: form.validade.value,
        quantidade: Number(form.quantidade.value)
      };

      try {
        const resposta = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const resultado = await resposta.json();

        if (!resposta.ok || !resultado.success) {
          throw new Error(resultado.error || 'Erro ao salvar o produto/lote.');
        }

        alert('Produto/lote adicionado com sucesso!');
        form.reset();
        await carregarProdutos();
      } catch (erro) {
        alert(erro.message);
      }
    });

    // Redireciona para p√°gina de detalhes
    function visualizarProduto(id) {
      window.location.href = `detalhes_produto.html?id=${id}`;
    }

    // Filtro de busca em tempo real
    buscarInput.addEventListener('input', e => {
      renderTabela(e.target.value);
    });

    // Atualiza dados a cada 30 segundos
    setInterval(carregarProdutos, 30000);

    carregarProdutos();
  </script>
</body>
</html>