<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>QR Code do Produto</title>
  <style>
    /* Estilos mantidos */
  </style>
</head>
<body>
  <div class="container">
    <a id="link-detalhes" class="voltar" href="detalhes_produto.html">&larr; Voltar</a>
    <!-- RF04 - Visualização e gerenciamento do QR Code -->
    <h1>QR Code do Produto</h1>
    <div id="status" class="status"></div>

    <div class="info">
      <h2 id="produto-nome">Produto</h2>
      <strong id="produto-categoria"></strong>
      <p><strong>Lote:</strong> <span id="produto-lote">-</span></p>
      <p><strong>Validade:</strong> <span id="produto-validade">-</span></p>
    </div>

    <!-- Container do QR Code gerado -->
    <div class="qr-wrapper">
      <div id="qr-code"></div>
      <a id="qr-link" target="_blank" rel="noopener">Gerando link...</a>
    </div>

    <div class="acoes">
      <!-- RF04.4 - Botão para remover QR Code -->
      <button id="btn-remover">Excluir QR Code</button>
    </div>
  </div>

  <!-- Biblioteca para geração de QR Code -->
  <script src="assets/js/qrcode.min.js"></script>
  <script>
    const API_URL = 'produtos.php';
    const statusBox = document.getElementById('status');
    const qrContainer = document.getElementById('qr-code');
    const qrLink = document.getElementById('qr-link');
    const btnRemover = document.getElementById('btn-remover');
    const linkDetalhes = document.getElementById('link-detalhes');
    const nomeEl = document.getElementById('produto-nome');
    const categoriaEl = document.getElementById('produto-categoria');
    const loteEl = document.getElementById('produto-lote');
    const validadeEl = document.getElementById('produto-validade');

    let produtoAtual = null;

    // Extrai ID do produto da URL
    function obterId() {
      const params = new URLSearchParams(window.location.search);
      const id = Number(params.get('id'));
      return Number.isFinite(id) && id > 0 ? id : null;
    }

    // Exibe mensagem de status
    function mostrarStatus(mensagem, tipo = 'success') {
      statusBox.textContent = mensagem;
      statusBox.className = `status ${tipo}`;
    }

    function limparStatus() {
      statusBox.textContent = '';
      statusBox.className = 'status';
    }

    // Monta URL para página de detalhes
    function montarUrlDetalhes(id) {
      const url = new URL(window.location.href);
      url.search = '';
      url.hash = '';
      url.pathname = url.pathname.replace(/qr_produto\.html$/, 'detalhes_produto.html');
      url.searchParams.set('id', id);
      return url.toString();
    }

    // Preenche informações básicas do produto
    function preencherInfo(produto) {
      nomeEl.textContent = produto.nome || 'Produto';
      categoriaEl.textContent = produto.categoria ? `Categoria: ${produto.categoria}` : '';
      loteEl.textContent = produto.lote || '-';
      validadeEl.textContent = (produto.validade || '').substring(0, 10) || '-';
    }

    // RF04.2 - Gera link para consulta do produto via QR Code
    function gerarLinkProduto(id) {
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/qr_produto\.html$/, 'detalhes_produto.html');
      url.search = `?id=${id}`;
      url.hash = '';
      return url.toString();
    }

    // RF04.1 - Gera QR Code visual usando biblioteca
    function gerarQrCode(url) {
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: url,
        width: 220,
        height: 220,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
      qrLink.textContent = url;
      qrLink.href = url;
    }

    // RF04.2 - Carrega dados do produto e gera QR Code
    async function carregarProduto() {
      const id = obterId();
      if (!id) {
        mostrarStatus('ID do produto não informado.', 'error');
        btnRemover.disabled = true;
        return;
      }

      linkDetalhes.href = montarUrlDetalhes(id);
      try {
        limparStatus();
        const resposta = await fetch(`${API_URL}?id=${id}`);
        const resultado = await resposta.json();
        if (!resposta.ok || !resultado.success) {
          throw new Error(resultado.error || 'Erro ao carregar o produto.');
        }

        produtoAtual = resultado.produto;
        preencherInfo(produtoAtual);
        
        // Verifica se QR Code está habilitado
        if (Number(produtoAtual.qr_code_habilitado) !== 1) {
          mostrarStatus('QR Code ainda não foi gerado para este produto.', 'error');
          btnRemover.disabled = true;
          qrContainer.innerHTML = '';
          qrLink.textContent = '';
          return;
        }

        const url = gerarLinkProduto(produtoAtual.id);
        gerarQrCode(url);
        btnRemover.disabled = false;
      } catch (erro) {
        mostrarStatus(erro.message, 'error');
        btnRemover.disabled = true;
      }
    }

    // RF04.4 - Remove QR Code do produto
    btnRemover.addEventListener('click', async () => {
      if (!produtoAtual) return;
      if (!confirm('Excluir o QR Code deste produto?')) {
        return;
      }

      try {
        const resposta = await fetch(`${API_URL}?id=${produtoAtual.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ acao: 'remover_qr' })
        });
        const resultado = await resposta.json();
        if (!resposta.ok || !resultado.success) {
          throw new Error(resultado.error || 'Não foi possível excluir o QR Code.');
        }
        alert('QR Code removido. Você será redirecionado.');
        window.location.href = montarUrlDetalhes(produtoAtual.id);
      } catch (erro) {
        mostrarStatus(erro.message, 'error');
      }
    });

    carregarProduto();
  </script>
</body>
</html>